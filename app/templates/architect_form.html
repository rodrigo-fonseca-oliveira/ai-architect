<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Architect</title>
    <style>
      :root { --bg:#0b0f14; --card:#121821; --muted:#9aa4b2; --accent:#2dd4bf; --border:#223045; }
      * { box-sizing: border-box; }
      html, body { height:100%; }
      body { margin:0; background: var(--bg); color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; overflow:hidden; }
      header { padding: 1rem 1.25rem; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:.75rem; }
      header .brand { font-weight:700; letter-spacing:.3px; }
      header .badge { font-size:.8rem; color: var(--muted); }
      main { display:grid; grid-template-columns: 1.2fr .8fr; gap:1px; height: calc(100vh - 60px); }
      .col { height:100%; }
      .left { display:flex; flex-direction:column; min-height:0; }
      .chat { flex:1; overflow:auto; padding: 1rem; }
      .bubble { max-width: 80%; padding: .75rem .9rem; margin: .5rem 0; border:1px solid var(--border); border-radius:12px; background:#0e141d; }
      .bubble.agent { background:#0f172a; border-color:#1f2a44; }
      .bubble.user { background:#111827; margin-left:auto; border-color:#263142; }
      .dock { border-top:1px solid var(--border); padding:.75rem; display:flex; gap:.5rem; background:#0e131a; }
      .dock textarea { flex:1; background:#0b1118; color:#e5e7eb; border:1px solid var(--border); border-radius:8px; padding:.6rem .7rem; resize:vertical; min-height:60px; max-height:30vh; }
      .dock button { background: var(--accent); color:#0b0f14; border:none; border-radius:8px; padding:.6rem .9rem; font-weight:600; cursor:pointer; }
      .dock .toggle { display:flex; align-items:center; gap:.4rem; color:var(--muted); }
      .right { background:#0e131a; border-left:1px solid var(--border); padding:0; display:flex; flex-direction:column; min-height:0; }
      .right .inner { padding:1rem; overflow:auto; flex:1; }
      .kvs { display:grid; grid-template-columns: .9fr 1.1fr; gap:.5rem .75rem; font-size:.95rem; }
      .k { color:var(--muted); }
      .v code { background:#0b1118; padding:.2rem .35rem; border-radius:4px; border:1px solid var(--border); }
      .section { margin:.75rem 0 1rem; }
      .badge { display:inline-block; padding:.15rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:.8rem; color:var(--muted); }
      details { border:1px solid var(--border); border-radius:8px; }
      summary { padding:.5rem .75rem; cursor:pointer; color:var(--muted); }
      pre { margin:0; padding: .75rem; overflow:auto; background:#0b1118; border-top:1px solid var(--border); white-space:pre-wrap; word-wrap:break-word; }
      a.cta { display:inline-block; margin-right:.5rem; margin-top:.5rem; }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">AI Architect</div>
      {% if not project_guide_enabled %}
        <span class="badge">PROJECT_GUIDE_ENABLED=false (API 404)</span>
      {% endif %}
    </header>
    <main>
      <div class="col left">
        <div id="chat" class="chat">
          <div class="bubble agent">Hi! Ask about your project setup, policies, or flags. I’ll stream a plan with citations when applicable.</div>
        </div>
        <div class="dock">
          <label class="toggle"><input id="streamToggle" type="checkbox" checked/> Stream <span id="streamingBadge" class="badge" style="display:none;">Streaming…</span></label>
          <textarea id="question" placeholder="E.g., How does the router work? or Adapt this for internal policy review."></textarea>
          <button id="sendBtn">Send</button>
        </div>
      </div>
      <div class="col right">
        <div class="inner">
          <div class="section">
          <span id="groundedBadge" class="badge">grounded: unknown</span>
          <span id="citationsCount" class="badge">citations: 0</span>
          <span id="sidBadge" class="badge">sid: -</span>
        </div>
        <div class="section kvs">
            <div class="k">Provider</div><div class="v" id="provider">-</div>
            <div class="k">Model</div><div class="v" id="model">-</div>
            <div class="k">Tokens</div><div class="v" id="tokens">-</div>
            <div class="k">Cost</div><div class="v" id="cost">-</div>
            <div class="k">RAG</div><div class="v" id="rag">-</div>
            <div class="k">Turns</div><div class="v" id="turns">1</div>
          </div>
          <div class="section">
            <details>
              <summary>Audit JSON</summary>
              <pre id="auditJson">{}</pre>
            </details>
          </div>
          <div class="section" id="featureCta" style="display:none;">
            <div>Want this as a feature? Create a GitHub Issue or copy a template.</div>
            <a id="ghIssue" class="cta badge" href="#" target="_blank">Create GitHub Issue</a>
            <button id="copyTemplate" class="cta">Copy Template</button>
          </div>
        </div>
      </div>
    </main>

    <script>
      const chatEl = document.getElementById('chat');
      const qEl = document.getElementById('question');
      const sendBtn = document.getElementById('sendBtn');
      const streamToggle = document.getElementById('streamToggle');

      const groundedBadge = document.getElementById('groundedBadge');
      const citationsCount = document.getElementById('citationsCount');
      const providerEl = document.getElementById('provider');
      const modelEl = document.getElementById('model');
      const tokensEl = document.getElementById('tokens');
      const costEl = document.getElementById('cost');
      const ragEl = document.getElementById('rag');
      const turnsEl = document.getElementById('turns');
      const auditJsonEl = document.getElementById('auditJson');

      const featureCta = document.getElementById('featureCta');
      const ghIssue = document.getElementById('ghIssue');
      const copyTemplate = document.getElementById('copyTemplate');
      const sidBadge = document.getElementById('sidBadge');

      // session persistence
      const SESSION_ID = (() => {
        try {
          let sid = localStorage.getItem('ai_architect_session_id');
          if (!sid) {
            sid = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
            localStorage.setItem('ai_architect_session_id', sid);
          }
          return sid;
        } catch (e) {
          return 'sess_' + Math.random().toString(36).slice(2);
        }
      })();
      console.debug('AI Architect SESSION_ID', SESSION_ID);
      if (sidBadge) sidBadge.textContent = `sid: ${SESSION_ID}`;
      function getSessionId(){ return SESSION_ID; }

      function updateSendState(){ const n=(qEl.value||'').trim().length; sendBtn.disabled = (n < 3) || isStreaming; }

      let turn = parseInt(localStorage.getItem('ai_architect_turn') || '1', 10);
      turnsEl.textContent = String(turn);
      let isStreaming = false;

      function addBubble(text, who='agent') {
        const div = document.createElement('div');
        div.className = `bubble ${who}`;
        div.textContent = text;
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function encodeRFC5987ValueChars(str) {
        return encodeURIComponent(str).replace(/['()]/g, escape).replace(/\*/g, '%2A');
      }

      function startStream(question) { console.debug('[AI Architect] startStream() raw=', question);
        const qq = (question || '').trim(); console.debug('[AI Architect] startStream() qq=', qq, 'sid=', SESSION_ID);
        if (qq.length < 3) { return; }
        const sid = encodeURIComponent(SESSION_ID);
        const qparam = encodeURIComponent(qq);
        const url = `/architect/stream?question=${qparam}&session_id=${sid}`;
        console.debug('[AI Architect] EventSource URL =', url);
        const es = new EventSource(url);
        let summaryParts = [];
        let summaryQueue = [];
        let typingTimer = null;
        let typingCursorOn = false;
        let stepsQueued = null; // buffer steps until summary starts typing
        let planBubble = null; // single container for summary+steps
        let planSummaryEl = null;
        let planStepsEl = null;
        let flagsBubble = null;
        const streamingBadge = document.getElementById('streamingBadge');

        es.addEventListener('meta', (e) => {
          const meta = JSON.parse(e.data);
          providerEl.textContent = meta.provider || '-';
          modelEl.textContent = meta.model || '-';
          groundedBadge.textContent = `grounded: ${meta.grounded_used ? 'yes' : 'no'}`;
        });
        es.addEventListener('summary', (e) => {
          const s = JSON.parse(e.data);
          if (!s || (typeof s === 'string' && s.trim().length === 0)) { return; }
          if (!planBubble) {
            planBubble = document.createElement('div');
            planBubble.className = 'bubble agent';
            planSummaryEl = document.createElement('div');
            planSummaryEl.className = 'plan-summary';
            planStepsEl = document.createElement('div');
            planStepsEl.className = 'plan-steps';
            planBubble.appendChild(planSummaryEl);
            planBubble.appendChild(planStepsEl);
            chatEl.appendChild(planBubble);
          }
          // Append summary content immediately (no typing effect)
          planSummaryEl.textContent += (typeof s === 'string' ? s : String(s)) + ' ';
          chatEl.scrollTop = chatEl.scrollHeight;
        });
        es.addEventListener('steps', (e) => {
          const arr = JSON.parse(e.data) || [];
          if (!arr || arr.length === 0) return;
          // Ensure plan bubble exists
          if (!planBubble) {
            planBubble = document.createElement('div');
            planBubble.className = 'bubble agent';
            planSummaryEl = document.createElement('div');
            planSummaryEl.className = 'plan-summary';
            planStepsEl = document.createElement('div');
            planStepsEl.className = 'plan-steps';
            planBubble.appendChild(planSummaryEl);
            planBubble.appendChild(planStepsEl);
            chatEl.appendChild(planBubble);
          }
          // Render steps immediately regardless of summary state
          planStepsEl.style.display = '';
          planStepsEl.textContent = 'Steps:\n- ' + arr.join('\n- ');
          // If summary hasn't arrived yet, keep placeholder empty; when summary arrives later, it will be inserted above steps
          stepsQueued = null;
          chatEl.scrollTop = chatEl.scrollHeight;
        });
        es.addEventListener('flags', (e) => {
          const arr = JSON.parse(e.data) || [];
          if (!flagsBubble) {
            flagsBubble = document.createElement('div');
            flagsBubble.className = 'bubble agent';
            chatEl.appendChild(flagsBubble);
          }
          flagsBubble.textContent = 'Flags: ' + arr.join(', ');
          chatEl.scrollTop = chatEl.scrollHeight;
        });
        es.addEventListener('citations', (e) => {
          const citations = JSON.parse(e.data) || [];
          citationsCount.textContent = `citations: `;
          if (!citations.length) return;
          const wrap = document.createElement('div');
          wrap.className = 'bubble agent';
          const header = document.createElement('div');
          const btn = document.createElement('button');
          btn.textContent = 'Show';
          btn.className = 'badge';
          btn.style.marginLeft = '8px';
          const title = document.createElement('span');
          title.textContent = `Citations ()`;
          const details = document.createElement('div');
          details.style.display = 'none';
          const ul = document.createElement('ul');
          ul.style.margin = '6px 0 0 16px';
          citations.forEach(c => {
            const li = document.createElement('li');
            let host = '';
            try { if (c.url) host = new URL(c.url).hostname; } catch {}
            if (c.url) {
              const a = document.createElement('a');
              a.href = c.url; a.textContent = c.title || c.url; a.target = '_blank';
              li.appendChild(a);
              if (host) { const h = document.createElement('span'); h.textContent = ` ()`; h.style.color = '#9aa4b2'; h.style.marginLeft = '4px'; li.appendChild(h); }
            } else {
              li.textContent = c.title || JSON.stringify(c);
            }
            ul.appendChild(li);
          });
          details.appendChild(ul);
          btn.onclick = () => {
            const show = details.style.display === 'none';
            details.style.display = show ? '' : 'none';
            btn.textContent = show ? 'Hide' : 'Show';
          };
          header.appendChild(title);
          header.appendChild(btn);
          wrap.appendChild(header);
          wrap.appendChild(details);
          chatEl.appendChild(wrap);
          chatEl.scrollTop = chatEl.scrollHeight;
        });
        es.addEventListener('feature', (e) => {
          const fr = JSON.parse(e.data);
          featureCta.style.display = 'block';
          const title = fr.title || 'AI Architect Feature Request';
          const body = fr.body || JSON.stringify(fr, null, 2);
          const url = `https://github.com/rodrigo-fonseca-oliveira/ai-architect/issues/new?title=&body=`;
          ghIssue.href = url;
          copyTemplate.onclick = () => {
            navigator.clipboard.writeText(`# \n\n`);
          };
        });
        es.addEventListener('audit', (e) => {
          audit = JSON.parse(e.data);
          auditJsonEl.textContent = JSON.stringify(audit, null, 2);
          const tokens = [audit.llm_tokens_prompt, audit.llm_tokens_completion].filter(x=>x!=null).join(' + ');
          tokensEl.textContent = tokens || '-';
          costEl.textContent = audit.llm_cost_usd != null ? `${audit.llm_cost_usd.toFixed ? audit.llm_cost_usd.toFixed(4) : audit.llm_cost_usd}` : '-';
          const ragBits = [
            audit.rag_multi_query ? `multi:` : null,
            audit.rag_hyde ? 'hyde:on' : null,
          ].filter(Boolean);
          ragEl.textContent = ragBits.length ? ragBits.join(', ') : '-';
          const cursor = document.getElementById('typingCursor'); if (cursor && cursor.parentElement) cursor.parentElement.removeChild(cursor);
          if (planSummaryEl && planSummaryEl.textContent) { planSummaryEl.textContent = planSummaryEl.textContent.replace(/^\s*\|\s*/, '').trim(); }
          if (typingTimer) { clearInterval(typingTimer); typingTimer = null; }
          es.close(); isStreaming = false; if (streamingBadge) streamingBadge.style.display = 'none'; updateSendState();
        });
        es.onerror = () => {
          es.close();
          isStreaming = false;
          updateSendState();
        };
      }

      function send() { console.debug('[AI Architect] send() invoked');
        const q = (qEl.value || '').trim(); console.debug('[AI Architect] send() q=', q, 'isStreaming=', isStreaming);
        if (q.length < 3 || isStreaming) { return; }
        addBubble(q, 'user');
        turnsEl.textContent = String(++turn);
        localStorage.setItem('ai_architect_turn', String(turn));
        if (streamToggle.checked) {
          isStreaming = true;
          if (streamingBadge) streamingBadge.style.display = 'inline-block';
          updateSendState();
          startStream(q);
        } else {
          fetch('/architect', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question: q, session_id: getSessionId() }) })
            .then(r => r.json())
            .then(data => {
              const { audit, suggested_steps, suggested_env_flags, citations } = data || {};
              if (data && data.answer) addBubble(data.answer, 'agent');
              if (Array.isArray(suggested_steps) && suggested_steps.length) addBubble(`Steps:\n- ${suggested_steps.join('\n- ')}`, 'agent');
              if (Array.isArray(suggested_env_flags) && suggested_env_flags.length) addBubble(`Flags: ${suggested_env_flags.join(', ')}`, 'agent');
              if (Array.isArray(citations) && citations.length) {
                citationsCount.textContent = `citations: ${citations.length}`;
              }
              if (audit) {
                auditJsonEl.textContent = JSON.stringify(audit, null, 2);
                providerEl.textContent = audit.llm_provider || '-';
                modelEl.textContent = audit.llm_model || '-';
                const tokens = [audit.llm_tokens_prompt, audit.llm_tokens_completion].filter(x=>x!=null).join(' + ');
                tokensEl.textContent = tokens || '-';
                costEl.textContent = audit.llm_cost_usd != null ? `$${audit.llm_cost_usd}` : '-';
                const ragBits = [
                  audit.rag_multi_query ? `multi:${audit.rag_multi_count||'-'}` : null,
                  audit.rag_hyde ? 'hyde:on' : null,
                ].filter(Boolean);
                ragEl.textContent = ragBits.length ? ragBits.join(', ') : '-';
              }
            })
            .catch(err => addBubble(`Error: ${err}`, 'agent'));
        }
        qEl.value = '';
      }

      sendBtn.onclick = send;
      qEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) { if (!isStreaming && (qEl.value||'').trim().length >= 3) send(); } });
      function updateSendState(){ const n=(qEl.value||'').trim().length; sendBtn.disabled = n < 3; }
      qEl.addEventListener('input', updateSendState); updateSendState();
    </script>
  </body>
</html>
